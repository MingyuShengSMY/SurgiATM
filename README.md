# SurgiATM
# SPRNet: SurgiATM: A Plug-and-Play Physics-Guided Model for Laparoscopic Surgery Smoke Removal [[Paper Link](https://arxiv.org/xxxxxx) not published yet]

[Mingyu Sheng]([https://mhamilton.net/](https://scholar.google.com/citations?user=P7MIBuMAAAAJ&hl=en&oi=ao))<sup>1</sup>,
[Jianan Fan](https://ieeexplore.ieee.org/author/37090057230)<sup>1</sup>,
[Dongnan Liu](https://scholar.google.com/citations?hl=en&user=JZzb8XUAAAAJ)<sup>1</sup>,
[Guoyan Zheng](https://scholar.google.com/citations?user=n01L0mEAAAAJ&hl=en&oi=ao)<sup>3</sup>,
[Ron Kikinis](https://scholar.google.com/citations?user=n01L0mEAAAAJ&hl=en&oi=ao)<sup>2</sup>,
[Weidong Cai](https://scholar.google.com/citations?hl=en&user=N8qTc2AAAAAJ)<sup>1</sup>

<sup>1</sup> [The University of Sydney](https://www.sydney.edu.au/), 
<sup>2</sup> [Shanghai Jiao Tong University](https://hms.harvard.edu/),
<sup>3</sup> [Harvard Medical School](https://hms.harvard.edu/)

## Method Overview

![](PaperFigure/method_overview_white.png)


## Setup
* Recommended Environment: Python 3.12.0+, Cuda 12.0+
* Install dependencies: `pip install -r requirements.txt`.

## Dataset Directory
```
./dataset
    └── DatasetName
        ├── GT
        │   ├── videoName1
        │   |   ├── frameName1.png
        │   |   └── frameName2.png
        │   └── videoName2
        ├── X
        │   ├── videoName1
        │   |   ├── frameName1.png
        │   |   └── frameName2.png
        │   └── videoName2
        └── X_syn
            ├── videoName1
            |   ├── frameName1.png
            |   └── frameName2.png
            └── videoName2
```
A demo dataset is prepared and is named "DemoDataset".


`GT`: Smokeless frames.

`X` and `X_syn`: Paired Smoky Frames, where `X` stores frames with real smoke, and `X_syn` stores simulated smoky frames.

## Generate Simulated Smoke

```bash
python generate_smoke_syn.py --dataset_name DatasetName
```

Paired simulated smoky images will be generated by reading images in `GT` and writing in `X_syn`. 


## Data Splitting

```bash
python split_dataset.py --dataset_name DatasetName --k_fold 5
```

`--dataset_name` is compulsorily required. 

Although `--k_fold` is set as a default value, you can adjust it as needed.

It will generate a folder `data_split` under the `./dataset/DatasetName`.

By default, the generated folder structure should be: 

```
./dataset/DatasetName/data_split
    ├── 1
    |   ├── train.txt
    |   └── val.txt
    ├── 2
    ├── 3
    ├── 4
    ├── 5
    └── all.txt
```

The folders `1`, `2`, ..., and `5` indicate different folds in K-Fold Cross-Validation.

`train.txt` and `val.txt` store paths of training data and validating data respectively.

`all.txt` contains all samples, particularly for Dark Channel Prior (DCP), because DCP does not need training.

Or, you can manually set the `txt` files.

## Config File

Config files are stored in `./ConfigFiles`. The config file defines the experiment configuration, such as training epoch, learning rate, dataset, etc..

For more information please check `./ConfigFiles/demo1.yaml`.

## Run

1. Click to download datasets [Cholec80](http://camma.u-strasbg.fr/datasets/) and [VASST-desmoke](https://github.com/wxia43/DesmokeData).

2. Arrange the data by following the [Dataset Directory](#Dataset-Directory).

3. [Generate simulated smoke](#Generate-Simulated-Smoke) for Cholec80 dataset or other un-paired datasets.

4. [Split data](#Data-Splitting).

5. Adjust config files as needed.

6. Start running:

```bash
python main.py --config_file ConfigFiles/demo1.yaml --train --test --vis
```

`--train` and `--test` will start training and testing mode respectively. At least one of them should be used.

`--vis` will visualize results in `--test` mode.

6. By default, folders `./log` and `./output` will be created to store loss log and output result respectively.


## Citation

Not published yet.















